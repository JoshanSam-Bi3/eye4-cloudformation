AWSTemplateFormatVersion: '2010-09-09'
Description: 'EKS Infrastructure-Only Stack - Pure CloudFormation (No CDK Dependencies)'

Parameters:
  ClusterName:
    Type: String
    Default: EksCluster
    Description: EKS Cluster Name
  KubernetesVersion:
    Type: String
    Default: '1.31'
    Description: Kubernetes Version
  AdminIAMArns:
    Type: CommaDelimitedList
    Description: IAM ARNs for cluster admin access

Resources:
  # ============================================================
  # VPC Configuration
  # ============================================================
  EksVpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: eks-vpc

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: eks-igw

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref EksVpc
      InternetGatewayId: !Ref InternetGateway

  # Public Subnet 1
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EksVpc
      CidrBlock: 10.0.0.0/19
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: eks-public-subnet-1
        - Key: kubernetes.io/role/elb
          Value: '1'

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EksVpc
      CidrBlock: 10.0.32.0/19
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: eks-public-subnet-2
        - Key: kubernetes.io/role/elb
          Value: '1'

  PublicSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EksVpc
      CidrBlock: 10.0.64.0/19
      AvailabilityZone: !Select [2, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: eks-public-subnet-3
        - Key: kubernetes.io/role/elb
          Value: '1'

  # Private Subnet 1
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EksVpc
      CidrBlock: 10.0.128.0/19
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: eks-private-subnet-1
        - Key: kubernetes.io/role/internal-elb
          Value: '1'

  # Private Subnet 2
  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EksVpc
      CidrBlock: 10.0.160.0/19
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: eks-private-subnet-2
        - Key: kubernetes.io/role/internal-elb
          Value: '1'

  # Private Subnet 3
  PrivateSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EksVpc
      CidrBlock: 10.0.192.0/19
      AvailabilityZone: !Select [2, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: eks-private-subnet-3
        - Key: kubernetes.io/role/internal-elb
          Value: '1'

  # NAT Gateway
  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: eks-nat-eip

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: eks-nat-gateway

  # Public Route Table
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref EksVpc
      Tags:
        - Key: Name
          Value: eks-public-rt

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet3
      RouteTableId: !Ref PublicRouteTable

  # Private Route Table
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref EksVpc
      Tags:
        - Key: Name
          Value: eks-private-rt

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet3
      RouteTableId: !Ref PrivateRouteTable

  # ============================================================
  # Security Groups
  # ============================================================
  EKSControlPlaneSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: EKS Control Plane Security Group
      VpcId: !Ref EksVpc
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: eks-control-plane-sg

  # ============================================================
  # IAM Roles
  # ============================================================
  EKSClusterRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: eks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSClusterPolicy

  EKSNodeRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
        - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly

  EKSNodeInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref EKSNodeRole

  # ============================================================
  # Launch Template - Ubuntu 22.04 EKS-optimized AMI
  # ============================================================
  UbuntuLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    DependsOn: EKSCluster
    Properties:
      LaunchTemplateName: !Sub '${ClusterName}-ubuntu-launch-template'
      LaunchTemplateData:
        # Official Ubuntu 22.04 EKS-optimized AMI for ap-southeast-2 + K8s 1.31
        ImageId: ami-0b6e743424057a5f3
        UserData:
          Fn::Base64:
            !Sub |
              MIME-Version: 1.0
              Content-Type: multipart/mixed; boundary="==MYBOUNDARY=="

              --==MYBOUNDARY==
              Content-Type: text/x-shellscript; charset="us-ascii"

              #!/bin/bash
              set -ex

              # Bootstrap the node to join the EKS cluster
              /etc/eks/bootstrap.sh '${ClusterName}' --apiserver-endpoint '${EKSCluster.Endpoint}' --b64-cluster-ca '${EKSCluster.CertificateAuthorityData}'

              --==MYBOUNDARY==--
        BlockDeviceMappings:
          - DeviceName: /dev/sda1
            Ebs:
              VolumeSize: 100
              VolumeType: gp2
              DeleteOnTermination: true
              Encrypted: true

  # ============================================================
  # EKS Cluster
  # ============================================================
  EKSCluster:
    Type: AWS::EKS::Cluster
    Properties:
      Name: !Ref ClusterName
      Version: !Ref KubernetesVersion
      RoleArn: !GetAtt EKSClusterRole.Arn
      ResourcesVpcConfig:
        SubnetIds:
          - !Ref PublicSubnet1
          - !Ref PublicSubnet2
          - !Ref PublicSubnet3
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
          - !Ref PrivateSubnet3
        SecurityGroupIds:
          - !Ref EKSControlPlaneSecurityGroup
        EndpointPublicAccess: true
        EndpointPrivateAccess: true
      Tags:
        - Key: Name
          Value: !Ref ClusterName

  # ============================================================
  # Node Group
  # ============================================================
  EKSNodeGroup:
    Type: AWS::EKS::Nodegroup
    DependsOn: UbuntuLaunchTemplate
    Properties:
      ClusterName: !Ref EKSCluster
      NodegroupName: cpu-nodegroup
      NodeRole: !GetAtt EKSNodeRole.Arn
      AmiType: CUSTOM
      LaunchTemplate:
        Id: !Ref UbuntuLaunchTemplate
        Version: !GetAtt UbuntuLaunchTemplate.LatestVersionNumber
      Subnets:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3
      InstanceTypes:
        - m5.xlarge
      ScalingConfig:
        MinSize: 1
        MaxSize: 2
        DesiredSize: 2
      Labels:
        workload: cpu
      Tags:
        environment: production

  # ============================================================
  # GPU Node Group - g4dn.xlarge with NVIDIA GPU taint
  # ============================================================
  GPUNodeGroup:
    Type: AWS::EKS::Nodegroup
    DependsOn: UbuntuLaunchTemplate
    Properties:
      ClusterName: !Ref EKSCluster
      NodegroupName: gpu-nodegroup
      NodeRole: !GetAtt EKSNodeRole.Arn
      AmiType: CUSTOM
      LaunchTemplate:
        Id: !Ref UbuntuLaunchTemplate
        Version: !GetAtt UbuntuLaunchTemplate.LatestVersionNumber
      Subnets:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3
      InstanceTypes:
        - g4dn.xlarge
      ScalingConfig:
        MinSize: 1
        MaxSize: 1
        DesiredSize: 1
      Labels:
        workload: gpu
      Taints:
        - Key: nvidia.com/gpu
          Value: 'true'
          Effect: NO_SCHEDULE
      Tags:
        environment: production

  # ============================================================
  # EKS Add-ons
  # ============================================================
  # EBS CSI Driver
  EBSCSIRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Fn::Sub:
          - |
            {
              "Version": "2012-10-17",
              "Statement": [{
                "Effect": "Allow",
                "Principal": {
                  "Federated": "${OIDCProviderArn}"
                },
                "Action": "sts:AssumeRoleWithWebIdentity",
                "Condition": {
                  "StringEquals": {
                    "${OIDCIssuer}:aud": "sts.amazonaws.com",
                    "${OIDCIssuer}:sub": "system:serviceaccount:kube-system:ebs-csi-controller-sa"
                  }
                }
              }]
            }
          - OIDCProviderArn: !GetAtt OIDCProvider.Arn
            OIDCIssuer: !Select [1, !Split ['://', !GetAtt EKSCluster.OpenIdConnectIssuerUrl]]
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy

  EBSCSIAddon:
    Type: AWS::EKS::Addon
    DependsOn: EKSNodeGroup
    Properties:
      AddonName: aws-ebs-csi-driver
      ClusterName: !Ref EKSCluster
      ServiceAccountRoleArn: !GetAtt EBSCSIRole.Arn
      ResolveConflicts: OVERWRITE
      PreserveOnDelete: false

  # Prometheus Node Exporter
  PrometheusNodeExporterAddon:
    Type: AWS::EKS::Addon
    DependsOn: EKSNodeGroup
    Properties:
      AddonName: prometheus-node-exporter
      AddonVersion: v1.10.2-eksbuild.4
      ClusterName: !Ref EKSCluster
      ResolveConflicts: OVERWRITE
      PreserveOnDelete: false

  # S3 CSI Driver
  S3CSIRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Fn::Sub:
          - |
            {
              "Version": "2012-10-17",
              "Statement": [{
                "Effect": "Allow",
                "Principal": {
                  "Federated": "${OIDCProviderArn}"
                },
                "Action": "sts:AssumeRoleWithWebIdentity",
                "Condition": {
                  "StringEquals": {
                    "${OIDCIssuer}:aud": "sts.amazonaws.com",
                    "${OIDCIssuer}:sub": "system:serviceaccount:kube-system:s3-csi-driver-sa"
                  }
                }
              }]
            }
          - OIDCProviderArn: !GetAtt OIDCProvider.Arn
            OIDCIssuer: !Select [1, !Split ['://', !GetAtt EKSCluster.OpenIdConnectIssuerUrl]]
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonS3FullAccess

  S3CSIAddon:
    Type: AWS::EKS::Addon
    DependsOn: EKSNodeGroup
    Properties:
      AddonName: aws-mountpoint-s3-csi-driver
      AddonVersion: v1.12.0-eksbuild.1
      ClusterName: !Ref EKSCluster
      ServiceAccountRoleArn: !GetAtt S3CSIRole.Arn
      ResolveConflicts: OVERWRITE
      PreserveOnDelete: false

  # EFS CSI Driver
  EFSCSIRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Fn::Sub:
          - |
            {
              "Version": "2012-10-17",
              "Statement": [{
                "Effect": "Allow",
                "Principal": {
                  "Federated": "${OIDCProviderArn}"
                },
                "Action": "sts:AssumeRoleWithWebIdentity",
                "Condition": {
                  "StringEquals": {
                    "${OIDCIssuer}:aud": "sts.amazonaws.com",
                    "${OIDCIssuer}:sub": "system:serviceaccount:kube-system:efs-csi-controller-sa"
                  }
                }
              }]
            }
          - OIDCProviderArn: !GetAtt OIDCProvider.Arn
            OIDCIssuer: !Select [1, !Split ['://', !GetAtt EKSCluster.OpenIdConnectIssuerUrl]]
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEFSCSIDriverPolicy

  EFSCSIAddon:
    Type: AWS::EKS::Addon
    DependsOn: EKSNodeGroup
    Properties:
      AddonName: aws-efs-csi-driver
      AddonVersion: v2.1.1-eksbuild.1
      ClusterName: !Ref EKSCluster
      ServiceAccountRoleArn: !GetAtt EFSCSIRole.Arn
      ResolveConflicts: OVERWRITE
      PreserveOnDelete: false

  # ============================================================
  # EFS Filesystem
  # ============================================================
  EFSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for EFS
      VpcId: !Ref EksVpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          CidrIp: 10.0.0.0/16
          Description: NFS from VPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound
      Tags:
        - Key: Name
          Value: eks-efs-sg

  EFSFileSystem:
    Type: AWS::EFS::FileSystem
    Properties:
      Encrypted: true
      PerformanceMode: generalPurpose
      ThroughputMode: bursting
      FileSystemPolicy:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: '*'
            Action:
              - elasticfilesystem:ClientMount
              - elasticfilesystem:ClientRootAccess
              - elasticfilesystem:ClientWrite
            Condition:
              Bool:
                elasticfilesystem:AccessedViaMountTarget: 'true'
      FileSystemTags:
        - Key: Name
          Value: eks-efs

  EFSMountTarget1:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EFSFileSystem
      SubnetId: !Ref PrivateSubnet1
      SecurityGroups:
        - !Ref EFSSecurityGroup

  EFSMountTarget2:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EFSFileSystem
      SubnetId: !Ref PrivateSubnet2
      SecurityGroups:
        - !Ref EFSSecurityGroup

  EFSMountTarget3:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EFSFileSystem
      SubnetId: !Ref PrivateSubnet3
      SecurityGroups:
        - !Ref EFSSecurityGroup

  # ============================================================
  # S3 Bucket for Testing
  # ============================================================
  S3TestBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 's3-fuse-test-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            NoncurrentVersionExpirationInDays: 7
            Status: Enabled
          - Id: ExpireObjects
            ExpirationInDays: 60
            Status: Enabled
      Tags:
        - Key: Name
          Value: eks-s3-fuse-test

  # S3 Bucket Policy - Grant Node Role and S3 CSI Role access
  S3TestBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3TestBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowNodeRoleAccess
            Effect: Allow
            Principal:
              AWS: !GetAtt EKSNodeRole.Arn
            Action:
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
              - s3:ListBucket
            Resource:
              - !GetAtt S3TestBucket.Arn
              - !Sub '${S3TestBucket.Arn}/*'
          - Sid: AllowS3CSIDriverAccess
            Effect: Allow
            Principal:
              AWS: !GetAtt S3CSIRole.Arn
            Action:
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
              - s3:ListBucket
            Resource:
              - !GetAtt S3TestBucket.Arn
              - !Sub '${S3TestBucket.Arn}/*'

  # ============================================================
  # OIDC Provider (for IRSA - IAM Roles for Service Accounts)
  # ============================================================
  OIDCProvider:
    Type: AWS::IAM::OIDCProvider
    DependsOn: EKSCluster
    Properties:
      Url: !GetAtt EKSCluster.OpenIdConnectIssuerUrl
      ThumbprintList:
        - '9e99a48a9960b14926bb7f3b02e22da2b0ab7280'
      ClientIdList:
        - sts.amazonaws.com

  # ============================================================
  # Eye4 WebAPI IRSA Role - SecretsManager Access
  # ============================================================
  Eye4WebApiIrsaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: Eye4WebApiIrsaRole
      Description: IRSA role for Eye4 WebAPI pod to access SecretsManager
      AssumeRolePolicyDocument:
        Fn::Sub:
          - |
            {
              "Version": "2012-10-17",
              "Statement": [{
                "Effect": "Allow",
                "Principal": {
                  "Federated": "${OIDCProviderArn}"
                },
                "Action": "sts:AssumeRoleWithWebIdentity",
                "Condition": {
                  "StringEquals": {
                    "${OIDCIssuer}:aud": "sts.amazonaws.com",
                    "${OIDCIssuer}:sub": "system:serviceaccount:eye4:eye4-sa"
                  }
                }
              }]
            }
          - OIDCProviderArn: !GetAtt OIDCProvider.Arn
            OIDCIssuer: !Select [1, !Split ['://', !GetAtt EKSCluster.OpenIdConnectIssuerUrl]]
      Policies:
        - PolicyName: Eye4SecretsManagerAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                  - secretsmanager:ListSecrets
                  - secretsmanager:ListSecretVersionIds
                  - secretsmanager:GetResourcePolicy
                  - secretsmanager:BatchGetSecretValue
                Resource: '*'

Outputs:
  ClusterName:
    Description: EKS Cluster Name
    Value: !Ref EKSCluster
    Export:
      Name: !Sub '${AWS::StackName}-ClusterName'

  ClusterEndpoint:
    Description: EKS Cluster API Endpoint
    Value: !GetAtt EKSCluster.Endpoint
    Export:
      Name: !Sub '${AWS::StackName}-ClusterEndpoint'

  ClusterSecurityGroup:
    Description: EKS Control Plane Security Group
    Value: !Ref EKSControlPlaneSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-ControlPlaneSG'

  VpcId:
    Description: VPC ID
    Value: !Ref EksVpc
    Export:
      Name: !Sub '${AWS::StackName}-VpcId'

  EFSFileSystemId:
    Description: EFS File System ID
    Value: !Ref EFSFileSystem
    Export:
      Name: !Sub '${AWS::StackName}-EFSId'

  S3BucketName:
    Description: S3 Test Bucket Name
    Value: !Ref S3TestBucket
    Export:
      Name: !Sub '${AWS::StackName}-S3Bucket'

  NodeGroupName:
    Description: EKS CPU Node Group Name
    Value: !Ref EKSNodeGroup
    Export:
      Name: !Sub '${AWS::StackName}-NodeGroup'

  GPUNodeGroupName:
    Description: EKS GPU Node Group Name
    Value: !Ref GPUNodeGroup
    Export:
      Name: !Sub '${AWS::StackName}-GPUNodeGroup'

  Eye4WebApiRoleArn:
    Description: IRSA Role ARN for Eye4 WebAPI ServiceAccount
    Value: !GetAtt Eye4WebApiIrsaRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-Eye4WebApiRoleArn'

  OIDCProviderArn:
    Description: OIDC Provider ARN for IRSA
    Value: !GetAtt OIDCProvider.Arn
    Export:
      Name: !Sub '${AWS::StackName}-OIDCProviderArn'
